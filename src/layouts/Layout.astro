---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';
---
<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href="/Logo.png" />
		<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.0/src/phosphor.css" />
		<meta name="generator" content={Astro.generator} />
		<title>Hydraulic Sistem - Reparación Hidráulica para Maquinaria Agrícola y Equipo Pesado</title>
		<meta name="description" content="Especialistas en reparación de cilindros, bombas, motores y comandos hidráulicos. Servicio a cosechadoras, tractores y equipo pesado. Importadores de repuestos hidráulicos." />
		<meta name="keywords" content="reparación hidráulica, cilindros hidráulicos, bombas hidráulicas, motores hidráulicos, comandos hidráulicos, cosechadoras, tractores, maquinaria agrícola, equipo pesado, repuestos hidráulicos, importación repuestos" />
	</head>
	<body>
		<Header />
		<main>
			<slot />
		</main>
		<Footer />
		<div class="cart-sidebar" id="cartSidebar" aria-hidden="true">
			<div class="cart-overlay" id="cartOverlay"></div>
			<aside class="cart-panel" role="dialog" aria-modal="true" aria-labelledby="cartTitulo">
				<div class="cart-header">
					<h3 id="cartTitulo">Tu carrito</h3>
					<button class="cart-close" id="cartClose" type="button" aria-label="Cerrar carrito">
						<span>&times;</span>
					</button>
				</div>
				<div class="cart-body">
					<div class="cart-empty" id="cartEmpty">
						<p>No hay productos en tu carrito todavía.</p>
						<small>Agrega piezas para cotizarlas y verlas aquí.</small>
					</div>
					<div class="cart-items" id="cartItems"></div>
				</div>
				<div class="cart-summary">
					<div class="cart-summary-row">
						<span>Total de productos</span>
						<strong id="cartTotalProductos">0 productos</strong>
					</div>
					<button class="cart-checkout" id="cartCheckout" type="button">
						Solicitar cotización
					</button>
				</div>
			</aside>
		</div>
	</body>
</html>

<style is:global>
	html {
		height: 100%;
	}

	body {
		margin: 0;
		width: 100%;
		min-height: 100vh;
		display: flex;
		flex-direction: column;
	}

	main {
		flex: 1;
	}

	.cart-sidebar {
		position: fixed;
		inset: 0;
		display: flex;
		justify-content: flex-end;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.3s ease;
		z-index: 1000;
	}

	.cart-sidebar.is-active {
		pointer-events: auto;
		opacity: 1;
	}

	.cart-overlay {
		position: absolute;
		inset: 0;
		background: rgba(24, 20, 18, 0.55);
		backdrop-filter: blur(4px);
	}

	.cart-panel {
		position: relative;
		width: min(420px, 90vw);
		background: var(--color-white);
		border-radius: 20px 0 0 20px;
		box-shadow: -25px 0 60px rgba(24, 20, 18, 0.2);
		display: flex;
		flex-direction: column;
		height: 100%;
		transform: translateX(100%);
		transition: transform 0.35s ease;
	}

	.cart-sidebar.is-active .cart-panel {
		transform: translateX(0);
	}

	.cart-header {
		padding: 1.75rem 1.75rem 1.25rem;
		display: flex;
		align-items: center;
		justify-content: space-between;
		border-bottom: 1px solid var(--color-gray-200);
	}

	.cart-header h3 {
		margin: 0;
		font-size: 1.5rem;
		color: var(--color-tertiary);
	}

	.cart-close {
		border: none;
		background: rgba(24, 20, 18, 0.08);
		width: 38px;
		height: 38px;
		border-radius: 50%;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-size: 1.4rem;
		color: var(--color-tertiary);
		cursor: pointer;
		transition: background 0.3s ease, transform 0.3s ease;
	}

	.cart-close:hover {
		background: rgba(225, 51, 44, 0.12);
		transform: rotate(90deg);
	}

	.cart-body {
		padding: 1.5rem 1.75rem;
		flex: 1;
		overflow-y: auto;
	}

	.cart-empty {
		text-align: center;
		color: var(--color-gray-600);
		display: none;
	}

	.cart-empty p {
		margin: 0 0 0.5rem;
		font-weight: 600;
	}

	.cart-items {
		display: flex;
		flex-direction: column;
		gap: 0.95rem;
	}

	.cart-item {
		display: grid;
		grid-template-columns: 74px 1fr;
		gap: 0.9rem;
		padding: 0.9rem 1.05rem;
		border-radius: 16px;
		background: linear-gradient(135deg, var(--color-secondary), #b91f1b);
		align-items: stretch;
		box-shadow: 0 10px 22px rgba(34, 30, 28, 0.16);
		border: 1px solid rgba(255, 255, 255, 0.2);
		position: relative;
		overflow: hidden;
		transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
		color: var(--color-white);
	}

	.cart-item::before {
		content: '';
		position: absolute;
		inset: -40% -30% auto auto;
		height: 160%;
		width: 160%;
		background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
		opacity: 0.4;
		z-index: 0;
		pointer-events: none;
	}

	.cart-item::after {
		content: '';
		position: absolute;
		inset: 0;
		border-radius: 16px;
		background: linear-gradient(140deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));
		opacity: 0;
		transition: opacity 0.2s ease;
		pointer-events: none;
		z-index: 0;
	}

	.cart-item:hover {
		transform: translateY(-3px);
		box-shadow: 0 14px 28px rgba(34, 30, 28, 0.2);
		border-color: rgba(255, 255, 255, 0.28);
	}

	.cart-item:hover::after {
		opacity: 1;
	}

	.cart-item-thumb,
	.cart-item-content {
		position: relative;
		z-index: 1;
	}

	.cart-item-thumb {
		width: 100%;
		height: 100%;
		min-height: 74px;
		border-radius: 14px;
		overflow: hidden;
		flex-shrink: 0;
		background: rgba(255, 255, 255, 0.18);
		border: 1px solid rgba(255, 255, 255, 0.35);
		display: flex;
		align-items: center;
		justify-content: center;
		box-shadow: inset 0 2px 8px rgba(24, 20, 18, 0.14);
		padding: 0.35rem;
	}

	.cart-item-thumb img {
		width: 100%;
		height: 100%;
		object-fit: contain;
		mix-blend-mode: normal;
	}

	.cart-item-content {
		display: grid;
		grid-template-rows: auto auto auto;
		gap: 0.65rem;
		color: var(--color-white);
		align-content: start;
	}

	.cart-item-header {
		display: flex;
		align-items: flex-start;
		justify-content: space-between;
		gap: 1rem;
	}

	.cart-item-title {
		display: flex;
		flex-direction: column;
		gap: 0.2rem;
	}

	.cart-item-name {
		margin: 0;
		font-size: 1rem;
		font-weight: 700;
		color: var(--color-white);
	}

	.cart-item-remove {
		border: 1px solid rgba(255, 255, 255, 0.35);
		background: rgba(255, 255, 255, 0.1);
		color: var(--color-white);
		width: 32px;
		height: 32px;
		border-radius: 12px;
		cursor: pointer;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-size: 1.1rem;
		transition: all 0.25s ease;
	}

	.cart-item-remove:hover {
		background: var(--color-white);
		color: var(--color-secondary);
		transform: translateY(-1px) scale(1.05);
		box-shadow: 0 6px 16px rgba(24, 20, 18, 0.22);
	}

	.cart-item-tags {
		display: flex;
		align-items: center;
		gap: 0.45rem;
		flex-wrap: wrap;
		margin: 0;
	}

	.cart-item-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.3rem;
		padding: 0.4rem 0.8rem;
		border-radius: 999px;
		font-size: 0.78rem;
		font-weight: 600;
		background: rgba(255, 255, 255, 0.18);
		color: var(--color-white);
	}

	.cart-item-badge.no-stock {
		background: rgba(255, 255, 255, 0.25);
		color: rgba(87, 11, 8, 0.95);
	}

	.cart-item-footer {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.8rem;
		flex-wrap: wrap;
		margin-top: auto;
	}

	.cart-item-quantity {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		background: rgba(255, 255, 255, 0.18);
		border-radius: 14px;
		padding: 0.3rem 0.55rem;
		border: 1px solid rgba(255, 255, 255, 0.3);
		backdrop-filter: blur(3px);
	}

	.cart-item-quantity-btn {
		width: 28px;
		height: 28px;
		border-radius: 10px;
		border: none;
		background: var(--color-white);
		color: var(--color-secondary);
		font-size: 0.9rem;
		font-weight: 700;
		cursor: pointer;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		box-shadow: 0 3px 8px rgba(24, 20, 18, 0.15);
		transition: all 0.2s ease;
	}

	.cart-item-quantity-btn:hover {
		background: rgba(255, 255, 255, 0.85);
		color: var(--color-secondary-dark);
		transform: translateY(-1px);
	}

	.cart-item-quantity-input {
		width: 48px;
		min-width: 42px;
		text-align: center;
		border: none;
		background: transparent;
		font-size: 0.95rem;
		font-weight: 600;
		color: var(--color-white);
	}

	.cart-item-quantity-input::-webkit-outer-spin-button,
	.cart-item-quantity-input::-webkit-inner-spin-button {
		-webkit-appearance: none;
		margin: 0;
	}

	.cart-summary {
		padding: 1.5rem 1.75rem 2rem;
		border-top: 1px solid var(--color-gray-200);
		background: var(--color-white);
		border-radius: 0 0 0 20px;
	}

	.cart-summary-row {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 1.25rem;
		font-size: 1rem;
		color: var(--color-tertiary);
	}

	.cart-checkout {
		width: 100%;
		border: none;
		border-radius: 12px;
		background: var(--color-secondary);
		color: var(--color-white);
		font-size: 1rem;
		font-weight: 700;
		padding: 0.95rem 1.25rem;
		cursor: pointer;
		transition: all 0.3s ease;
		box-shadow: 0 8px 25px rgba(225, 51, 44, 0.3);
	}

	.cart-checkout:hover {
		background: var(--color-secondary-dark);
		transform: translateY(-2px);
		box-shadow: 0 12px 30px rgba(225, 51, 44, 0.4);
	}

	@media (max-width: 768px) {
		.cart-sidebar {
			align-items: flex-end;
		}

		.cart-panel {
			width: 100%;
			border-radius: 20px 20px 0 0;
			height: auto;
			max-height: 80vh;
		}

		.cart-body {
			padding: 1.25rem 1.5rem;
		}

		.cart-summary {
			padding: 1.25rem 1.5rem 1.75rem;
			border-radius: 0;
		}

		.cart-item {
			grid-template-columns: 1fr;
			gap: 1rem;
			padding: 1rem 1.1rem 1.15rem;
		}

		.cart-item-thumb {
			min-height: 68px;
		}

		.cart-item-footer {
			align-items: flex-start;
			justify-content: flex-start;
			gap: 0.75rem;
		}

		.cart-item-quantity {
			width: 100%;
			justify-content: space-between;
		}
	}
</style>

<script>
	// @ts-nocheck
	/**
	 * @typedef {Object} CartItem
	 * @property {string} id
	 * @property {string} nombre
	 * @property {string | null} imagen
	 * @property {number} stock
	 * @property {number} cantidad
	 */

	/**
	 * @typedef {Object} CartManager
	 * @property {(producto: Omit<CartItem, 'cantidad'>, cantidad?: number) => void} addItem
	 * @property {(productoId: string) => void} removeItem
	 * @property {(productoId: string, nuevaCantidad: number) => void} updateItemQuantity
	 * @property {() => void} clear
	 * @property {() => CartItem[]} getItems
	 * @property {() => void} openCart
	 * @property {() => void} closeCart
	 * @property {() => boolean} isOpen
	 */

	/**
	 * @typedef {Window & typeof globalThis & { cartManager?: CartManager }} WindowWithCart
	 */

	document.addEventListener('DOMContentLoaded', () => {
		const cartSidebar = document.getElementById('cartSidebar');
		if (!cartSidebar) return;

		const cartOverlay = document.getElementById('cartOverlay');
		const cartClose = document.getElementById('cartClose');
		const cartItems = document.getElementById('cartItems');
		const cartEmpty = document.getElementById('cartEmpty');
		const cartTotalProductos = document.getElementById('cartTotalProductos');
		const cartCheckout = document.getElementById('cartCheckout');
		const headerCartButton = document.querySelector('.header-cart');
		const cartCountBadge = document.getElementById('cartCount');
		const storageKey = 'hydraulic-sistem-cart';
		const state = /** @type {{ items: CartItem[] }} */ ({
			items: []
		});

		const isBrowser = typeof window !== 'undefined' && typeof localStorage !== 'undefined';

		/**
		 * @returns {CartItem[]}
		 */
		const loadCart = () => {
			if (!isBrowser) return [];
			try {
				const raw = localStorage.getItem(storageKey);
				if (!raw) return [];
				const parsed = /** @type {unknown} */ (JSON.parse(raw));
				if (!Array.isArray(parsed)) return [];
				return parsed
					.map((item) => ({
						id: String(item.id ?? ''),
						nombre: item.nombre ?? 'Producto sin nombre',
						imagen: item.imagen ?? null,
						stock: Number(item.stock ?? 0),
						cantidad: Math.max(1, Math.floor(Number(item.cantidad ?? 1)))
					}))
					.filter((item) => item.id);
			} catch (error) {
				console.warn('No se pudo leer el carrito almacenado', error);
				return [];
			}
		};

		const saveCart = () => {
			if (!isBrowser) return;
			try {
				localStorage.setItem(storageKey, JSON.stringify(state.items));
			} catch (error) {
				console.warn('No se pudo guardar el carrito', error);
			}
		};

		const updateBadge = () => {
			if (!cartCountBadge) return;
			const total = state.items.reduce((acc, item) => acc + item.cantidad, 0);
			cartCountBadge.textContent = String(total);
			cartCountBadge.style.display = total > 0 ? 'inline-flex' : 'none';
		};

		const isOpen = () => cartSidebar.classList.contains('is-active');

		const syncBodyScroll = () => {
			const modalAbierto = document.querySelector('.modal-detalle.is-active');
			document.body.style.overflow = isOpen() || modalAbierto ? 'hidden' : '';
		};

		const openCart = () => {
			cartSidebar.classList.add('is-active');
			cartSidebar.setAttribute('aria-hidden', 'false');
			syncBodyScroll();
		};

		const closeCart = () => {
			cartSidebar.classList.remove('is-active');
			cartSidebar.setAttribute('aria-hidden', 'true');
			syncBodyScroll();
		};

		/**
		 * @param {string} productoId
		 */
		function removeItem(productoId) {
			const index = state.items.findIndex((item) => item.id === productoId);
			if (index === -1) return;
			state.items.splice(index, 1);
			saveCart();
			renderCart();
		}

		/**
		 * @param {string} productoId
		 * @param {number} nuevaCantidad
		 */
		function updateItemQuantity(productoId, nuevaCantidad) {
			const item = state.items.find((entrada) => entrada.id === productoId);
			if (!item) return;
			const cantidadNormalizada = Math.max(1, Math.floor(Number(nuevaCantidad) || 1));
			const stockDisponible = Number(item.stock ?? 0);
			item.cantidad = stockDisponible > 0 ? Math.min(cantidadNormalizada, stockDisponible) : cantidadNormalizada;
			saveCart();
			renderCart();
		}

		/**
		 * @returns {void}
		 */
		function renderCart() {
			if (!cartItems || !cartEmpty || !cartTotalProductos) return;

			cartItems.innerHTML = '';

			if (state.items.length === 0) {
				cartEmpty.style.display = 'block';
				cartItems.style.display = 'none';
				cartTotalProductos.textContent = '0 productos';
				updateBadge();
				return;
			}

			cartEmpty.style.display = 'none';
			cartItems.style.display = 'flex';

			let totalProductos = 0;

			state.items.forEach((item) => {
				totalProductos += item.cantidad;

				const itemElement = document.createElement('div');
				itemElement.className = 'cart-item';
				itemElement.dataset.productoId = item.id;

		const stockBadge =
					item.stock > 0
						? `<span class="cart-item-badge">Stock: ${item.stock}</span>`
						: `<span class="cart-item-badge no-stock">Sin stock</span>`;

				itemElement.innerHTML = `
					<div class="cart-item-thumb">
						<img src="${item.imagen ?? '/placeholder-producto.jpg'}" alt="${item.nombre ?? 'Producto en carrito'}" />
					</div>
					<div class="cart-item-content">
						<div class="cart-item-header">
							<div class="cart-item-title">
								<h4 class="cart-item-name">${item.nombre ?? 'Producto'}</h4>
							</div>
							<button class="cart-item-remove" type="button" aria-label="Quitar ${item.nombre ?? 'producto'}">&times;</button>
						</div>
						<div class="cart-item-tags">
							${stockBadge}
						</div>
						<div class="cart-item-footer">
							<div class="cart-item-quantity">
								<button class="cart-item-quantity-btn" type="button" data-action="decremento" aria-label="Disminuir cantidad">&minus;</button>
								<input class="cart-item-quantity-input" type="number" min="1" step="1" value="${item.cantidad}" aria-label="Cantidad en carrito" />
								<button class="cart-item-quantity-btn" type="button" data-action="incremento" aria-label="Aumentar cantidad">+</button>
							</div>
						</div>
					</div>
				`;

				const btnMinus = itemElement.querySelector('[data-action="decremento"]');
				const btnPlus = itemElement.querySelector('[data-action="incremento"]');
				const input = itemElement.querySelector('.cart-item-quantity-input');
				const btnRemove = itemElement.querySelector('.cart-item-remove');

				btnMinus?.addEventListener('click', () => updateItemQuantity(item.id, item.cantidad - 1));
				btnPlus?.addEventListener('click', () => updateItemQuantity(item.id, item.cantidad + 1));
				input?.addEventListener('change', () => {
					const valor = Math.max(1, Math.floor(Number(input.value) || 1));
					updateItemQuantity(item.id, valor);
				});
				btnRemove?.addEventListener('click', () => removeItem(item.id));

				cartItems.appendChild(itemElement);
			});

			cartTotalProductos.textContent = `${totalProductos} producto${totalProductos === 1 ? '' : 's'}`;
			updateBadge();
		}

		/**
		 * @param {Omit<CartItem, 'cantidad'>} producto
		 * @param {number} [cantidad=1]
		 */
		function addItem(producto, cantidad = 1) {
			if (!producto || !producto.id) return;
			const cantidadNormalizada = Math.max(1, Math.floor(Number(cantidad) || 1));
			const stockDisponible = Number(producto.stock ?? 0);
			const cantidadLimite = stockDisponible > 0 ? Math.min(cantidadNormalizada, stockDisponible) : cantidadNormalizada;

			const existente = state.items.find((item) => item.id === producto.id);
			if (existente) {
				const nuevaCantidad = existente.cantidad + cantidadLimite;
				existente.cantidad = stockDisponible > 0 ? Math.min(nuevaCantidad, stockDisponible) : nuevaCantidad;
				existente.nombre = producto.nombre ?? existente.nombre;
				existente.imagen = producto.imagen ?? existente.imagen;
				existente.stock = stockDisponible;
			} else {
				state.items.push({
					id: producto.id,
					nombre: producto.nombre ?? 'Producto sin nombre',
					imagen: producto.imagen ?? null,
					stock: stockDisponible,
					cantidad: cantidadLimite
				});
			}

			saveCart();
			renderCart();
			openCart();
		}

		/**
		 * @returns {void}
		 */
		function clearCart() {
			state.items = [];
			saveCart();
			renderCart();
			closeCart();
		}

		headerCartButton?.addEventListener('click', () => {
			if (isOpen()) {
				closeCart();
			} else {
				renderCart();
				openCart();
			}
		});

		cartClose?.addEventListener('click', closeCart);
		cartOverlay?.addEventListener('click', closeCart);

		cartCheckout?.addEventListener('click', () => {
			if (state.items.length === 0) {
				closeCart();
				return;
			}

			const resumen = state.items
				.map((item, index) => `${index + 1}. ${item.nombre ?? 'Producto'} (ID: ${item.id}) - Cantidad: ${item.cantidad}`)
				.join('\n');

			const mensaje = `Solicitud de cotización - Carrito\n\n${resumen}`;
			const url = `https://api.whatsapp.com/send?phone=59169200281&text=${encodeURIComponent(mensaje)}`;
			window.open(url, '_blank');
		});

		document.addEventListener('keydown', (event) => {
			if (event.key === 'Escape' && isOpen()) {
				closeCart();
			}
		});

		state.items = loadCart();
		renderCart();

		/** @type {WindowWithCart} */ (window).cartManager = {
			addItem,
			removeItem,
			updateItemQuantity,
			clear: clearCart,
			getItems: () => state.items.map((item) => ({ ...item })),
			openCart,
			closeCart,
			isOpen
		};

		document.dispatchEvent(new CustomEvent('cart-ready'));
	});
</script>
